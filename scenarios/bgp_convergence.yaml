# BGP Convergence Test Scenario
# This scenario tests BGP route convergence under various network conditions

name: "BGP Convergence Test"
description: "Test BGP route convergence with network impairments"
duration: 300  # 5 minutes

# Router configuration
router:
  hostname: "router-sim-1"
  router_id: "1.1.1.1"
  as_number: 65001
  
  interfaces:
    - name: "eth0"
      ip_address: "192.168.1.1"
      subnet_mask: "255.255.255.0"
      mtu: 1500
      enabled: true
    - name: "eth1"
      ip_address: "192.168.2.1"
      subnet_mask: "255.255.255.0"
      mtu: 1500
      enabled: true

# Protocol configuration
protocols:
  bgp:
    enabled: true
    as_number: 65001
    router_id: "1.1.1.1"
    
    neighbors:
      - address: "192.168.1.2"
        as_number: 65002
        hold_time: 180
        keepalive_time: 60
      - address: "192.168.2.2"
        as_number: 65003
        hold_time: 180
        keepalive_time: 60

  ospf:
    enabled: true
    router_id: "1.1.1.1"
    area_id: "0.0.0.0"
    
    interfaces:
      - name: "eth0"
        area_id: "0.0.0.0"
        cost: 10
        priority: 1
      - name: "eth1"
        area_id: "0.0.0.0"
        cost: 10
        priority: 1

  isis:
    enabled: false
    system_id: "0000.0000.0001"
    area_id: "49.0001"

# Traffic shaping configuration
traffic_shaping:
  interfaces:
    - name: "eth0"
      algorithm: "token_bucket"
      token_bucket:
        capacity: 1000000  # 1MB
        rate: 100000       # 100KB/s
        burst_size: 500000 # 500KB
        allow_burst: true
    
    - name: "eth1"
      algorithm: "wfq"
      wfq:
        classes:
          - class_id: 1
            weight: 10
            min_bandwidth: 1000000  # 1MB/s
            max_bandwidth: 10000000 # 10MB/s
            name: "High Priority"
            is_active: true
          - class_id: 2
            weight: 5
            min_bandwidth: 500000   # 500KB/s
            max_bandwidth: 5000000  # 5MB/s
            name: "Medium Priority"
            is_active: true
          - class_id: 3
            weight: 1
            min_bandwidth: 100000   # 100KB/s
            max_bandwidth: 1000000  # 1MB/s
            name: "Low Priority"
            is_active: true

# Network impairments
impairments:
  interfaces:
    - name: "eth0"
      delay:
        delay_ms: 50
        jitter_ms: 10
        distribution: "normal"
      
      loss:
        loss_type: "random"
        loss_percentage: 0.1  # 0.1% packet loss
      
      duplicate:
        duplicate_percentage: 0.05  # 0.05% duplication
    
    - name: "eth1"
      delay:
        delay_ms: 100
        jitter_ms: 20
        distribution: "normal"
      
      rate_limit:
        rate: "10mbit"
        burst: 1000000
        latency: 50

# Test scenarios
scenarios:
  - name: "baseline"
    description: "Baseline test with no impairments"
    duration: 60
    steps: []
  
  - name: "high_latency"
    description: "Test with high latency"
    duration: 120
    steps:
      - type: "delay"
        interface: "eth0"
        delay_ms: 0
        config:
          delay_ms: "200"
          jitter_ms: "50"
          distribution: "normal"
  
  - name: "packet_loss"
    description: "Test with packet loss"
    duration: 120
    steps:
      - type: "loss"
        interface: "eth0"
        delay_ms: 0
        config:
          loss_type: "random"
          loss_percentage: "2.0"
  
  - name: "unreliable_network"
    description: "Test with multiple impairments"
    duration: 180
    steps:
      - type: "delay"
        interface: "eth0"
        delay_ms: 0
        config:
          delay_ms: "100"
          jitter_ms: "25"
          distribution: "normal"
      - type: "loss"
        interface: "eth0"
        delay_ms: 1000
        config:
          loss_type: "random"
          loss_percentage: "1.0"
      - type: "duplicate"
        interface: "eth0"
        delay_ms: 2000
        config:
          duplicate_percentage: "0.5"
  
  - name: "bandwidth_limited"
    description: "Test with bandwidth limitation"
    duration: 120
    steps:
      - type: "rate_limit"
        interface: "eth0"
        delay_ms: 0
        config:
          rate: "1mbit"
          burst: "100000"
          latency: "50"

# Test routes to advertise
routes:
  - prefix: "10.0.0.0/24"
    next_hop: "192.168.1.2"
    as_path: "65001"
    origin: "igp"
    local_pref: 100
    med: 0
    community: "65001:100"
  
  - prefix: "10.0.1.0/24"
    next_hop: "192.168.2.2"
    as_path: "65001"
    origin: "igp"
    local_pref: 100
    med: 0
    community: "65001:100"

# Expected results
expected_results:
  convergence_time:
    baseline: 5.0      # seconds
    high_latency: 15.0
    packet_loss: 25.0
    unreliable_network: 45.0
    bandwidth_limited: 30.0
  
  route_stability:
    min_routes: 2
    max_convergence_time: 60.0
  
  neighbor_stability:
    min_neighbors: 2
    max_flaps: 3

# Monitoring configuration
monitoring:
  metrics:
    - name: "convergence_time"
      type: "timer"
      unit: "seconds"
    - name: "route_count"
      type: "gauge"
      unit: "routes"
    - name: "neighbor_count"
      type: "gauge"
      unit: "neighbors"
    - name: "packet_loss_rate"
      type: "gauge"
      unit: "percentage"
    - name: "throughput"
      type: "gauge"
      unit: "bps"
  
  alerts:
    - name: "convergence_timeout"
      condition: "convergence_time > 60"
      severity: "warning"
    - name: "route_instability"
      condition: "route_count < 2"
      severity: "critical"
    - name: "neighbor_down"
      condition: "neighbor_count < 2"
      severity: "critical"

# Reporting configuration
reporting:
  output_format: "json"
  output_file: "bgp_convergence_results.json"
  include_pcap: true
  include_logs: true
  
  charts:
    - name: "convergence_time"
      type: "line"
      x_axis: "time"
      y_axis: "convergence_time"
    - name: "route_count"
      type: "bar"
      x_axis: "scenario"
      y_axis: "route_count"
    - name: "throughput"
      type: "line"
      x_axis: "time"
      y_axis: "throughput"