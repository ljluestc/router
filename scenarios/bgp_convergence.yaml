name: "BGP Convergence Test"
description: "Test BGP convergence time and route learning"
version: "1.0"
author: "Router Simulator Team"

# Test configuration
test:
  duration: 300  # seconds
  iterations: 10
  timeout: 30    # seconds per iteration

# Network topology
topology:
  nodes:
    - id: "router-1"
      type: "transit"
      asn: 65001
      interfaces:
        - name: "eth0"
          ip: "192.168.1.1/24"
          type: "internal"
        - name: "eth1"
          ip: "10.0.0.1/24"
          type: "external"
    
    - id: "router-2"
      type: "transit"
      asn: 65002
      interfaces:
        - name: "eth0"
          ip: "192.168.1.2/24"
          type: "internal"
        - name: "eth2"
          ip: "172.16.0.1/24"
          type: "external"
    
    - id: "router-3"
      type: "spoke"
      asn: 65003
      interfaces:
        - name: "eth0"
          ip: "10.0.0.2/24"
          type: "external"
        - name: "eth1"
          ip: "10.1.0.1/24"
          type: "internal"

# BGP configuration
bgp:
  enabled: true
  router_id: "192.168.1.1"
  asn: 65001
  neighbors:
    - address: "192.168.1.2"
      asn: 65002
      type: "ibgp"
      keepalive: 30
      holdtime: 90
      password: "bgp123"
      policies:
        - type: "import"
          action: "permit"
          prefix: "172.16.0.0/16"
        - type: "export"
          action: "permit"
          prefix: "10.0.0.0/8"
    
    - address: "10.0.0.2"
      asn: 65003
      type: "ebgp"
      keepalive: 30
      holdtime: 90
      password: "bgp456"
      policies:
        - type: "import"
          action: "permit"
          prefix: "10.1.0.0/16"
        - type: "export"
          action: "permit"
          prefix: "192.168.0.0/16"

# Routes to advertise
routes:
  - prefix: "10.0.0.0/8"
    next_hop: "10.0.0.1"
    origin: "igp"
    local_pref: 100
    med: 0
    communities: ["65001:100"]
  
  - prefix: "192.168.0.0/16"
    next_hop: "192.168.1.1"
    origin: "igp"
    local_pref: 100
    med: 0
    communities: ["65001:200"]

# Test scenarios
scenarios:
  - name: "normal_convergence"
    description: "Test normal BGP convergence"
    steps:
      - action: "start_bgp"
        target: "all"
        wait: 5
      
      - action: "advertise_routes"
        target: "router-1"
        routes: ["10.0.0.0/8", "192.168.0.0/16"]
        wait: 10
      
      - action: "verify_routes"
        target: "router-2"
        expected_routes: ["10.0.0.0/8", "192.168.0.0/16"]
        timeout: 30
      
      - action: "verify_routes"
        target: "router-3"
        expected_routes: ["192.168.0.0/16"]
        timeout: 30
  
  - name: "link_failure"
    description: "Test BGP convergence after link failure"
    steps:
      - action: "start_bgp"
        target: "all"
        wait: 5
      
      - action: "advertise_routes"
        target: "router-1"
        routes: ["10.0.0.0/8", "192.168.0.0/16"]
        wait: 10
      
      - action: "verify_routes"
        target: "router-2"
        expected_routes: ["10.0.0.0/8", "192.168.0.0/16"]
        timeout: 30
      
      - action: "bring_interface_down"
        target: "router-1"
        interface: "eth1"
        wait: 5
      
      - action: "verify_route_withdrawal"
        target: "router-2"
        withdrawn_routes: ["10.0.0.0/8"]
        timeout: 30
      
      - action: "bring_interface_up"
        target: "router-1"
        interface: "eth1"
        wait: 5
      
      - action: "verify_routes"
        target: "router-2"
        expected_routes: ["10.0.0.0/8", "192.168.0.0/16"]
        timeout: 30
  
  - name: "route_flap"
    description: "Test BGP route flap dampening"
    steps:
      - action: "start_bgp"
        target: "all"
        wait: 5
      
      - action: "enable_route_flap_dampening"
        target: "router-1"
        half_life: 15
        reuse: 750
        suppress: 2000
        max_suppress: 60
      
      - action: "advertise_routes"
        target: "router-1"
        routes: ["10.0.0.0/8"]
        wait: 5
      
      - action: "withdraw_routes"
        target: "router-1"
        routes: ["10.0.0.0/8"]
        wait: 5
      
      - action: "repeat"
        count: 5
        steps:
          - action: "advertise_routes"
            target: "router-1"
            routes: ["10.0.0.0/8"]
            wait: 2
          - action: "withdraw_routes"
            target: "router-1"
            routes: ["10.0.0.0/8"]
            wait: 2
      
      - action: "verify_route_dampened"
        target: "router-2"
        dampened_routes: ["10.0.0.0/8"]
        timeout: 30

# Performance metrics
metrics:
  - name: "convergence_time"
    description: "Time for BGP to converge after route change"
    unit: "seconds"
    threshold: 30
  
  - name: "route_count"
    description: "Number of routes learned"
    unit: "count"
    threshold: 2
  
  - name: "update_messages"
    description: "Number of BGP update messages sent"
    unit: "count"
    threshold: 10
  
  - name: "memory_usage"
    description: "Memory usage during test"
    unit: "MB"
    threshold: 100

# Expected results
expected_results:
  convergence_time:
    min: 1.0
    max: 30.0
    average: 5.0
  
  route_count:
    min: 2
    max: 2
  
  update_messages:
    min: 2
    max: 10
  
  memory_usage:
    min: 10
    max: 100

# Test data collection
data_collection:
  enabled: true
  interval: 1  # seconds
  metrics:
    - "bgp_neighbors"
    - "bgp_routes"
    - "bgp_updates"
    - "system_cpu"
    - "system_memory"
    - "network_traffic"
  
  output:
    format: "json"
    file: "bgp_convergence_results.json"
    include_packets: true
    include_routes: true

# Cleanup
cleanup:
  - action: "stop_bgp"
    target: "all"
  
  - action: "clear_routes"
    target: "all"
  
  - action: "reset_interfaces"
    target: "all"